import React, { useState, useMemo, useEffect } from 'react';
import { Search, MapPin, Package, Plus, Minus, Edit2, Trash2, PlusCircle, Filter, Beaker, X, Save, TestTube, Database, CloudUpload, RefreshCw, AlertTriangle, ClipboardList, User, Calendar, CheckCircle, Clock, History, AlertCircle, Check } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, orderBy, query } from 'firebase/firestore';

// =================================================================
// âœ… ì„ ìƒë‹˜ì˜ Firebase ì„¤ì •
// =================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBP6oC0RH728IWwpTZxSGTRiS8ivVqdhjs",
  authDomain: "yeoulsciencelab.firebaseapp.com",
  projectId: "yeoulsciencelab",
  storageBucket: "yeoulsciencelab.firebasestorage.app",
  messagingSenderId: "353295377528",
  appId: "1:353295377528:web:83dd4c370c48e49e47f98d"
};

// ì•± ì´ˆê¸°í™”
let app, auth, db;
let initError = null;
const PROJECT_ID = "yeoulsciencelab"; 

try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) {
  console.warn("Firebase initialization failed:", e);
  initError = e.message;
}

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('search');
  const [searchTerm, setSearchTerm] = useState('');
  
  // Inventory State
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [newItem, setNewItem] = useState({ location: '', item: '', quantity: 0, room: '2ê³¼í•™ì‹¤' });
  const [editItemData, setEditItemData] = useState({});
  const [roomFilter, setRoomFilter] = useState('all');
  const [inventory, setInventory] = useState([]);
  
  // Loan State
  const [loans, setLoans] = useState([]);
  const [newLoan, setNewLoan] = useState({ borrower: '', itemId: '', itemName: '', quantity: 1 });
  
  // System State
  const [loading, setLoading] = useState(true);
  const [uploading, setUploading] = useState(false);
  const [isOffline, setIsOffline] = useState(!!initError || !app);
  const [connectionError, setConnectionError] = useState(null);

  // UI State
  const [toast, setToast] = useState(null); // { message, type: 'success' | 'error' }
  const [deleteConfirmId, setDeleteConfirmId] = useState(null); // For 2-step delete

  // --- Helper: Toast Notification ---
  const showToast = (message, type = 'success') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 3000);
  };

  // --- Auth & Data Sync ---
  useEffect(() => {
    if (!app) {
      setInventory(initialInventory.map((item, idx) => ({ ...item, id: idx.toString() })));
      setLoading(false);
      return;
    }

    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Auth failed:", err);
        setConnectionError("ë¡œê·¸ì¸ ì‹¤íŒ¨: ìµëª… ë¡œê·¸ì¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        setIsOffline(true);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Fetch Inventory
  useEffect(() => {
    if (!user || !db) return;

    const inventoryRef = collection(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory');
    const unsubscribeInventory = onSnapshot(inventoryRef, (snapshot) => {
      const items = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      items.sort((a, b) => {
        if (a.room !== b.room) return a.room.localeCompare(b.room);
        return a.item.localeCompare(b.item);
      });
      
      setInventory(items);
      setLoading(false);
    }, (error) => {
      console.error("Error fetching inventory:", error);
      setLoading(false);
      if (inventory.length === 0) {
         setInventory(initialInventory.map((item, idx) => ({ ...item, id: idx.toString() })));
      }
    });

    return () => unsubscribeInventory();
  }, [user]);

  // Fetch Loans
  useEffect(() => {
    if (!user || !db) return;

    const loansRef = collection(db, 'artifacts', PROJECT_ID, 'public', 'data', 'loans');
    const unsubscribeLoans = onSnapshot(loansRef, (snapshot) => {
      const loanItems = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      loanItems.sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate));
      setLoans(loanItems);
    }, (error) => {
      console.error("Error fetching loans:", error);
    });

    return () => unsubscribeLoans();
  }, [user]);

  // --- CRUD Operations (Inventory) ---
  const addItem = async () => {
    if (newItem.item && newItem.location) {
      if (user && db && !connectionError) {
        try {
          const collectionRef = collection(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory');
          await addDoc(collectionRef, newItem);
          showToast("ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          showToast("ì €ì¥ ì‹¤íŒ¨: " + e.message, 'error');
          return;
        }
      } else {
        setInventory(prev => [...prev, { ...newItem, id: Date.now().toString() }]);
        showToast("ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¬¼í’ˆì´ ì„ì‹œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      setNewItem({ location: '', item: '', quantity: 0, room: '2ê³¼í•™ì‹¤' });
      setShowAddForm(false);
    }
  };

  const deleteItem = async (id) => {
    // 2-step deletion
    if (deleteConfirmId !== id) {
      setDeleteConfirmId(id);
      setTimeout(() => setDeleteConfirmId(null), 3000); // Reset after 3s
      return;
    }

    if (user && db && !connectionError) {
      const docRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory', id);
      await deleteDoc(docRef);
      showToast("ë¬¼í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      setInventory(prev => prev.filter(item => item.id !== id));
      showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    setDeleteConfirmId(null);
  };

  const adjustQuantity = async (id, currentQty, delta) => {
    const newQty = Math.max(0, (currentQty || 0) + delta);
    if (user && db && !connectionError) {
      const docRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory', id);
      await updateDoc(docRef, { quantity: newQty });
    } else {
      setInventory(prev => prev.map(item => item.id === id ? { ...item, quantity: newQty } : item));
    }
  };

  const saveEditing = async (id) => {
    if (user && db && !connectionError) {
      const docRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory', id);
      await updateDoc(docRef, editItemData);
      showToast("ìˆ˜ì •ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      setInventory(prev => prev.map(item => item.id === id ? editItemData : item));
      showToast("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    setEditingId(null);
  };

  // --- CRUD Operations (Loans) ---
  const addLoan = async () => {
    if (!newLoan.borrower || !newLoan.itemId) {
      showToast("ëŒ€ì—¬ì ì´ë¦„ê³¼ ë¬¼í’ˆì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
      return;
    }

    const selectedItem = inventory.find(i => i.id === newLoan.itemId);
    if (!selectedItem) {
        showToast("ì„ íƒí•œ ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
        return;
    }

    // ì¬ê³  í™•ì¸
    if (selectedItem.quantity < newLoan.quantity) {
        showToast(`ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: ${selectedItem.quantity}ê°œ)`, 'error');
        return;
    }

    const loanData = {
      borrower: newLoan.borrower,
      itemId: newLoan.itemId,
      itemName: selectedItem.item,
      itemRoom: selectedItem.room,
      quantity: newLoan.quantity,
      borrowDate: new Date().toLocaleString('ko-KR'),
      returnDate: null,
      status: 'borrowed'
    };

    if (user && db && !connectionError) {
      try {
        const batch = writeBatch(db);
        
        // 1. ëŒ€ì—¬ ê¸°ë¡ ìƒì„±
        const loanRef = doc(collection(db, 'artifacts', PROJECT_ID, 'public', 'data', 'loans'));
        batch.set(loanRef, loanData);

        // 2. ì¬ê³  ì°¨ê°
        const inventoryRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory', newLoan.itemId);
        batch.update(inventoryRef, { quantity: selectedItem.quantity - newLoan.quantity });

        await batch.commit();
        showToast("ëŒ€ì—¬ ì²˜ë¦¬ ë° ì¬ê³  ì°¨ê° ì™„ë£Œ");
      } catch (e) {
        showToast("ëŒ€ì—¬ ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message, 'error');
        return;
      }
    } else {
      // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì²˜ë¦¬
      setLoans(prev => [{ ...loanData, id: Date.now().toString() }, ...prev]);
      setInventory(prev => prev.map(item => 
        item.id === newLoan.itemId 
          ? { ...item, quantity: item.quantity - newLoan.quantity }
          : item
      ));
      showToast("ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ëŒ€ì—¬ ê¸°ë¡ ë° ì¬ê³  ì°¨ê°");
    }

    setNewLoan({ borrower: '', itemId: '', itemName: '', quantity: 1 });
  };

  const returnLoan = async (loanId) => {
    const loanToReturn = loans.find(l => l.id === loanId);
    if (!loanToReturn) return;

    const returnDate = new Date().toLocaleString('ko-KR');
    const itemInInventory = inventory.find(i => i.id === loanToReturn.itemId);

    if (user && db && !connectionError) {
      try {
        const batch = writeBatch(db);
        
        // 1. ë°˜ë‚© ìƒíƒœ ì—…ë°ì´íŠ¸
        const loanRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'loans', loanId);
        batch.update(loanRef, {
          returnDate: returnDate,
          status: 'returned'
        });

        // 2. ì¬ê³  ë³µêµ¬ (ë¬¼í’ˆì´ ì‚­ì œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ)
        if (itemInInventory) {
          const inventoryRef = doc(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory', loanToReturn.itemId);
          batch.update(inventoryRef, { quantity: itemInInventory.quantity + loanToReturn.quantity });
        }

        await batch.commit();
        showToast("ë°˜ë‚© ì²˜ë¦¬ ë° ì¬ê³  ë³µêµ¬ ì™„ë£Œ");
      } catch (e) {
        showToast("ë°˜ë‚© ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message, 'error');
        return;
      }
    } else {
      // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì²˜ë¦¬
      setLoans(prev => prev.map(l => l.id === loanId ? { ...l, returnDate, status: 'returned' } : l));
      if (itemInInventory) {
        setInventory(prev => prev.map(item => 
            item.id === loanToReturn.itemId 
              ? { ...item, quantity: item.quantity + loanToReturn.quantity }
              : item
          ));
      }
      showToast("ë°˜ë‚© ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  };

  const uploadInitialData = async () => {
    if (!user || !db) return;
    if (connectionError) {
      showToast("ì„œë²„ ì—°ê²° ë¬¸ì œë¡œ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
      return;
    }
    // Simple alert replacement
    const confirmUpload = window.confirm('ì´ë¯¸ ë°ì´í„°ê°€ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ˆê¸° ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!confirmUpload) return;
    
    setUploading(true);
    try {
      const batch = writeBatch(db);
      const collectionRef = collection(db, 'artifacts', PROJECT_ID, 'public', 'data', 'inventory');
      
      let count = 0;
      for (const item of initialInventory) {
        const newDocRef = doc(collectionRef);
        const { id, ...itemData } = item;
        batch.set(newDocRef, itemData);
        count++;
        if (count >= 400) {
           await batch.commit();
           count = 0;
        }
      }
      if (count > 0) await batch.commit();
      showToast("ì´ˆê¸° ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!");
    } catch (e) {
      showToast("ì—…ë¡œë“œ ì˜¤ë¥˜: " + e.message, 'error');
    } finally {
      setUploading(false);
    }
  };

  // --- Local State Helpers & Data ---
  const startEditing = (item) => {
    setEditingId(item.id);
    setEditItemData({ ...item });
  };

  const cancelEditing = () => {
    setEditingId(null);
    setEditItemData({});
  };

  const experiments = [
    { name: 'ë‹¨ì› í‰ê°€', grade: '3-6', tools: ['ìŠ¤í‹°ì»¤', 'ê°€ìœ„'] },
    { name: 'ë‚˜ì¹¨ë°˜ ë§Œë“¤ê¸°', grade: '3', tools: ['ë‚˜ì¹¨ë°˜', 'ë§‰ëŒ€ìì„'] },
    { name: 'ìì„ ë†€ì´', grade: '3', tools: ['ë§‰ëŒ€ìì„', 'ìì„6ì¢…ì„¸íŠ¸'] },
    { name: 'ê·¸ë¦¼ì ê´€ì°°', grade: '3', tools: ['ì†ì „ë“±', 'ìŠ¤íƒ ë“œ'] },
    { name: 'ì•¡ì²´ ê´€ì°°', grade: '4', tools: ['ë¹„ì»¤', 'ìŠ¤í¬ì´íŠ¸', 'í˜íŠ¸ë¦¬ì ‘ì‹œ'] },
    { name: 'í˜¼í•©ë¬¼ ë¶„ë¦¬', grade: '4', tools: ['ë¹„ì»¤', 'ê¹”ëŒ€ê¸°', 'ê±°ë¦„ì¢…ì´', 'ìœ ë¦¬ë§‰ëŒ€'] },
    { name: 'ìš©í•´ì™€ ìš©ì•¡', grade: '5', tools: ['ë¹„ì»¤', 'ìœ ë¦¬ë§‰ëŒ€', 'ìŠ¤í¬ì´íŠ¸', 'í˜íŠ¸ë¦¬ì ‘ì‹œ'] },
    { name: 'ì‚°ê³¼ ì—¼ê¸°', grade: '5', tools: ['ë¹„ì»¤', 'PHë¯¸í„°ê¸°', 'ìŠ¤í¬ì´íŠ¸', 'ì‹œí—˜ê´€'] },
    { name: 'ì „ê¸°íšŒë¡œ', grade: '6', tools: ['ì „ì§€', 'ì „ì§€ë¼ìš°ê°œ', 'ì§‘ê²Œì „ì„ ', 'ê¼¬ë§ˆì „êµ¬', 'ìŠ¤ìœ„ì¹˜'] },
    { name: 'ì „ìì„', grade: '6', tools: ['ì „ìì„ë§Œë“¤ê¸° ì¬ë£Œ', 'ì „ì§€', 'ë‚˜ì¹¨ë°˜'] },
    { name: 'ë Œì¦ˆ', grade: '6', tools: ['ë³¼ë¡ë Œì¦ˆ', 'ì˜¤ëª©ë Œì¦ˆ', 'í‰ë©´ë Œì¦ˆ', 'ë ˆì´ì €í¬ì¸í„°'] },
    { name: 'ë¹›ì˜ êµ´ì ˆ', grade: '6', tools: ['ì‚¼ê°í”„ë¦¬ì¦˜', 'ë ˆì´ì €í¬ì¸í„°', 'ë³¼ë¡ë Œì¦ˆ'] },
    { name: 'ì—°ì†Œ', grade: '6', tools: ['ì•Œì½œë¨í”„', 'ì‚¼ë°œì´', 'ì„¸ë¼ë¯¹ê·¸ë¬¼ë§', 'ë¹„ì»¤', 'ì§‘ê¸°ë³‘'] },
    { name: 'ê¸°ì²´ ë°œìƒ', grade: '6', tools: ['ì‚¼ê°í”Œë¼ìŠ¤í¬', 'ì‹œí—˜ê´€', 'ê³ ë¬´ë§ˆê°œ', 'ã„±ììœ ë¦¬ê´€', 'ì§‘ê¸°ë³‘'] },
    { name: 'í˜„ë¯¸ê²½ ê´€ì°°', grade: '6', tools: ['ê´‘í•™í˜„ë¯¸ê²½', 'í˜íŠ¸ë¦¬ì ‘ì‹œ', 'ìŠ¬ë¼ì´ë“œê¸€ë¼ìŠ¤', 'ìŠ¤í¬ì´íŠ¸'] },
    { name: 'í˜¸í¡', grade: '6', tools: ['í˜¸í¡ìš´ë™ì‹¤í—˜ëª¨í˜•', 'íëª¨í˜•'] },
    { name: 'ì‹¬ì¥', grade: '6', tools: ['íŒí”„', 'ì²­ì§„ê¸°'] },
    { name: 'ë¼ˆì™€ ê·¼ìœ¡', grade: '6', tools: ['ì¸ì²´ëª¨í˜•', 'íŒ”ê·¼ìœ¡ëª¨í˜•'] },
    { name: 'ìš©ìˆ˜ì² ', grade: '5', tools: ['ìš©ìˆ˜ì² ', 'ë¬´ê²Œì¶”', 'ì'] },
    { name: 'ì˜¨ë„ê³„', grade: '3-6', tools: ['ì•Œì½”ì˜¬ì˜¨ë„ê³„', 'ë””ì§€í„¸ì˜¨ë„ê³„'] },
    { name: 'íƒœì–‘ ê´€ì°°', grade: '6', tools: ['íƒœì–‘ê³ ë„ì¸¡ì •ê¸°', 'ë‚˜ì¹¨ë°˜'] },
    { name: 'ì§€êµ¬ì™€ ë‹¬', grade: '6', tools: ['ì§€êµ¬ì˜', 'ì§€êµ¬+ë‹¬ ê³µì „ëª¨í˜•'] },
    { name: 'ë¬¼ì˜ ìƒíƒœë³€í™”', grade: '3', tools: ['ë¹„ì»¤', 'ì•Œì½œë¨í”„', 'ì‚¼ë°œì´', 'ì˜¨ë„ê³„'] },
    { name: 'ë¬¼ì²´ì˜ ë¬´ê²Œ', grade: '3', tools: ['ì „ìì €ìš¸', 'ìš©ìˆ˜ì² ì €ìš¸'] },
    { name: 'ìì„', grade: '3', tools: ['ë§‰ëŒ€ìì„', 'ìì„6ì¢…ì„¸íŠ¸', 'ë‚˜ì¹¨ë°˜'] }
  ];
  
  const initialInventory = [
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'êµ¬ê¸‰ìƒì', quantity: 1, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ë°©ì§„ë§ˆìŠ¤í¬', quantity: 40, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ëˆˆì„¸ì²™ê¸°', quantity: 1, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ì¼íšŒìš©ë§ˆìŠ¤í¬', quantity: 50, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ë‚´ì—´ì¥ê°‘', quantity: 13, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ë©´ì¥ê°‘', quantity: 20, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 1', item: 'ë³´ì•ˆê²½(ë ˆì´ì €ìš©)', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 1', item: 'ë³´ì•ˆê²½(ì¼ë°˜ìš©)', quantity: 25, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 2', item: 'ë¼í…ìŠ¤ì‹¤í—˜ìš© ì¥ê°‘ S', quantity: 225, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 2', item: 'ë¼í…ìŠ¤ì‹¤í—˜ìš© ì¥ê°‘ M', quantity: 225, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 3', item: 'ì»¤íŒ…ë§¤íŠ¸', quantity: 7, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 3', item: 'ë©€í‹°íƒ­', quantity: 2, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 11', item: 'ë¹„ì»¤ 250ml', quantity: 12, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 11', item: 'ë¹„ì»¤ 300ml', quantity: 24, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 11', item: 'ë¹„ì»¤ 500ml', quantity: 26, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 11', item: 'ë¹„ì»¤ 1L', quantity: 24, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 11', item: 'ë¹„ì»¤ 100ml', quantity: 21, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 13,15', item: 'ì‚¬ê°ìˆ˜ì¡°(ëŒ€)', quantity: 10, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 15', item: 'ì‚¬ê°ìˆ˜ì¡°(ì†Œ)', quantity: 8, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼êµ 16', item: 'ì›í˜•ìˆ˜ì¡°(ëŒ€)', quantity: 5, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 19(ìƒ)', item: 'ê¹”ëŒ€ê¸°(ìœ ë¦¬+í”Œë¼ìŠ¤í‹±)', quantity: 22, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 20(ìƒ)', item: 'ì•Œì½œë¨í”„', quantity: 12, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 20(ìƒ)', item: 'ì‚¼ë°œì´', quantity: 7, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 21(í•˜)', item: 'ì—´ì „êµ¬(ì ì™¸ì„ ì „êµ¬)', quantity: 4, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 21(í•˜)', item: 'ì „ê¸°ìŠ¤íƒ ë“œ(ê°“ì—†ìŒ)', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 22(ìƒ)', item: 'í˜¸í¡ìš´ë™ì‹¤í—˜ëª¨í˜•', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 22(ìƒ)', item: 'ì§„ê³µì‹¤í—˜ì¥ì¹˜', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 22(ìƒ)', item: 'ì „ìì €ìš¸', quantity: 8, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'ë ˆì´ì €í¬ì¸í„°', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'ì†ì „ë“±', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'í‰ë©´ë Œì¦ˆ', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'ì‚¼ê°í”„ë¦¬ì¦˜', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'ë³¼ë¡ë Œì¦ˆ', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'ì˜¤ëª©ë Œì¦ˆ', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 29(í•˜)', item: 'ì§€êµ¬ì˜', quantity: 5, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 29(í•˜)', item: 'ì§€êµ¬+ë‹¬ ê³µì „ëª¨í˜•', quantity: 2, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 29(í•˜)', item: 'ë‚˜ì¹¨ë°˜', quantity: 10, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 30(ìƒ)', item: 'ë§‰ëŒ€ìì„', quantity: 15, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 24(ìƒ)', item: 'ì „ì§€', quantity: 50, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 24(ìƒ)', item: 'ì „ì§€ë¼ìš°ê°œ', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 24(ìƒ)', item: 'ì§‘ê²Œì „ì„ ', quantity: 40, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 24(ìƒ)', item: 'ê¼¬ë§ˆì „êµ¬', quantity: 50, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 24(ìƒ)', item: 'ì „ìì„ë§Œë“¤ê¸° ì¬ë£Œ', quantity: 20, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 25', item: 'íŒ”ê·¼ìœ¡ëª¨í˜•', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 25', item: 'ì¸ì²´ëª¨í˜•', quantity: 3, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 28(ìƒ)', item: 'ì•Œì½”ì˜¬ì˜¨ë„ê³„', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ì„œë)', item: 'ìœ ë¦¬ë§‰ëŒ€', quantity: 25, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 28(ì„œë)', item: 'PHë¯¸í„°ê¸°', quantity: 3, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 28(ì„œë)', item: 'ã„±ììœ ë¦¬ê´€', quantity: 20, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 28(ì„œë)', item: 'ê³ ë¬´ë§ˆê°œ', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 28(ì„œë)', item: 'í•€ì…‹', quantity: 20, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 20(í•˜)', item: 'ì‹œí—˜ê´€(ìœ ë¦¬)', quantity: 40, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 20(í•˜)', item: 'ì‹œí—˜ê´€(í”Œë¼ìŠ¤í‹±)', quantity: 50, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 19(í•˜)', item: 'í˜íŠ¸ë¦¬ì ‘ì‹œ(ìœ ë¦¬)', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 19(í•˜)', item: 'í˜íŠ¸ë¦¬ì ‘ì‹œ(í”Œë¼ìŠ¤í‹±)', quantity: 40, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 19(ìƒ)', item: 'ìŠ¤í¬ì´íŠ¸(ìœ ë¦¬)', quantity: 30, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 19(ìƒ)', item: 'ìŠ¤í¬ì´íŠ¸(ì¼íšŒìš©)', quantity: 200, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 18(ìƒ)', item: 'ì‚¼ê°í”Œë¼ìŠ¤í¬ 100ml', quantity: 15, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 18(ìƒ)', item: 'ì‚¼ê°í”Œë¼ìŠ¤í¬ 250ml', quantity: 12, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 21(í•˜)', item: 'ì§‘ê¸°ë³‘ 250ml', quantity: 8, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 21(í•˜)', item: 'ì§‘ê¸°ë³‘ 500ml', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 20(ìƒ)', item: 'ì„¸ë¼ë¯¹ê·¸ë¬¼ë§', quantity: 10, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 27(ìƒ)', item: 'íƒœì–‘ê³ ë„ì¸¡ì •ê¸°', quantity: 8, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 30(í•˜)', item: 'ì²­ì§„ê¸°', quantity: 5, room: '1ê³¼í•™ì‹¤' },
    { location: '1ê³¼ì¤€ 22(ìƒ)', item: 'íŒí”„', quantity: 6, room: '1ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 1', item: 'ë©´ì¥ê°‘', quantity: 50, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 1', item: 'ë‚´ì—´ì¥ê°‘', quantity: 15, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 1', item: 'ë³´ì•ˆê²½(ì¼ë°˜ìš©)', quantity: 30, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 10', item: 'ë¹„ì»¤ 500ml', quantity: 19, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 10', item: 'ë¹„ì»¤ 1000ml', quantity: 8, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 10', item: 'ì „ê¸°ì£¼ì „ì(ì»¤í”¼í¬íŠ¸)', quantity: 2, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 12', item: 'ë¹„ì»¤ 200ml', quantity: 19, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 12', item: 'ë¹„ì»¤ 50ml', quantity: 30, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 12', item: 'ë¹„ì»¤ 100ml', quantity: 11, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 12', item: 'ë¹„ì»¤ 300ml', quantity: 27, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 2', item: 'ë¼í…ìŠ¤ì‹¤í—˜ìš© ì¥ê°‘ S', quantity: 300, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 2', item: 'ë¼í…ìŠ¤ì‹¤í—˜ìš© ì¥ê°‘ M', quantity: 450, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 2', item: 'ë§ˆìŠ¤í¬ ì¤‘í˜•', quantity: 400, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 2', item: 'ì§€í¼ë°±', quantity: 400, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 2', item: 'ìœ„ìƒë°±', quantity: 1500, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 6(ìƒ)', item: 'ë¸”ë£¨íˆ¬ìŠ¤í”¼ì»¤', quantity: 9, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ 6(ìƒ)', item: 'ì†Œë¦¬êµ½ì‡ ', quantity: 6, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'êµ¬ê¸‰ìƒì', quantity: 1, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ë°©ì§„ë§ˆìŠ¤í¬', quantity: 40, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼êµ ì•ˆì „ë³´ê´€í•¨', item: 'ëˆˆì„¸ì²™ê¸°', quantity: 1, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€', item: 'ì§€êµ¬ë³¸', quantity: 6, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€', item: 'ì›í˜•ìˆ˜ì¡°(ëŒ€)', quantity: 11, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€', item: 'ì›í˜•ìˆ˜ì¡°(ì†Œ)', quantity: 12, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ìƒ)', item: 'ì‹œí—˜ê´€(í”Œë¼ìŠ¤í‹±)', quantity: 30, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ìƒ)', item: 'ì‹œí—˜ê´€(ìœ ë¦¬)', quantity: 14, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ìƒ)', item: 'ìŠ¤í¬ì´íŠ¸(ì¼íšŒìš©)', quantity: 300, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ì„œë)', item: 'í•€ì…‹', quantity: 27, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ì„œë)', item: 'ìœ ë¦¬ë§‰ëŒ€', quantity: 40, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 17(ì„œë)', item: 'ì´ˆì‹œê³„', quantity: 20, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 18(ìƒ)', item: 'ì‚¼ê°í”Œë¼ìŠ¤í¬ 100ml', quantity: 9, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 18(ìƒ)', item: 'ì•Œì½œë¨í”„+ì•Œì½”ì˜¬', quantity: 6, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 19(ìƒ)', item: 'ë°”ì´ì•Œë³‘', quantity: 120, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 19(ìƒ)', item: 'ë‹ë³´ê¸°', quantity: 29, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 19(í•˜)', item: 'ê´‘í•™í˜„ë¯¸ê²½', quantity: 6, room: '2ê³¼í•™ì‹¤' },
    { location: '2ê³¼ì¤€ 19(ìƒ)', item: 'ìì„6ì¢…ì„¸íŠ¸', quantity: 30, room: '2ê³¼í•™ì‹¤' },
  ];

  const findToolsForExperiment = (experimentName) => {
    const normalize = (str) => str.toLowerCase().replace(/\s+/g, '');
    const term = normalize(experimentName);
    const exp = experiments.find(e => {
      const normName = normalize(e.name);
      return normName.includes(term) || term.includes(normName);
    });

    if (!exp) return null;
    
    const tools = exp.tools;
    const foundItems = [];
    
    tools.forEach(tool => {
      const matches = inventory.filter(item => 
        item.item.toLowerCase().includes(tool.toLowerCase()) || 
        tool.toLowerCase().includes(item.item.toLowerCase())
      );
      foundItems.push(...matches);
    });
    
    const uniqueItems = Array.from(new Set(foundItems.map(a => a.id)))
      .map(id => foundItems.find(a => a.id === id));
    
    return { experiment: exp, items: uniqueItems };
  };

  const filteredInventory = useMemo(() => {
    if (roomFilter === 'all') return inventory;
    return inventory.filter(item => item.room === roomFilter);
  }, [inventory, roomFilter]);

  const searchResults = useMemo(() => {
    if (!searchTerm.trim()) return { type: 'none', data: [] };
    
    const expResult = findToolsForExperiment(searchTerm);
    if (expResult) {
      return { type: 'experiment', data: expResult };
    }
    
    const term = searchTerm.toLowerCase();
    const items = filteredInventory.filter(item => 
      item.item.toLowerCase().includes(term) || item.location.toLowerCase().includes(term)
    );
    
    return { type: 'items', data: items };
  }, [searchTerm, filteredInventory]);

  // Derived state for loans
  const activeLoans = useMemo(() => loans.filter(l => l.status === 'borrowed'), [loans]);
  const returnedLoans = useMemo(() => loans.filter(l => l.status === 'returned'), [loans]);

  const InventoryCard = ({ item, highlight = false }) => (
    <div key={item.id} className={`bg-white rounded-xl shadow-sm border-l-4 p-5 transition-all hover:shadow-md ${item.room === '1ê³¼í•™ì‹¤' ? 'border-green-500' : 'border-blue-500'} ${highlight ? 'ring-2 ring-indigo-200' : ''}`}>
      {editingId === item.id ? (
        <div className="space-y-3 animate-fade-in">
          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="text-xs text-gray-500">ë¬¼í’ˆëª…</label>
              <input type="text" value={editItemData.item} onChange={(e) => setEditItemData({...editItemData, item: e.target.value})} className="w-full border rounded p-1 text-sm" />
            </div>
            <div>
              <label className="text-xs text-gray-500">ìœ„ì¹˜</label>
              <input type="text" value={editItemData.location} onChange={(e) => setEditItemData({...editItemData, location: e.target.value})} className="w-full border rounded p-1 text-sm" />
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="flex-1">
              <label className="text-xs text-gray-500">ìˆ˜ëŸ‰</label>
              <input type="number" value={editItemData.quantity} onChange={(e) => setEditItemData({...editItemData, quantity: parseInt(e.target.value) || 0})} className="w-full border rounded p-1 text-sm" />
            </div>
            <div className="flex-1">
               <label className="text-xs text-gray-500">ê³¼í•™ì‹¤</label>
               <select value={editItemData.room} onChange={(e) => setEditItemData({...editItemData, room: e.target.value})} className="w-full border rounded p-1 text-sm">
                 <option value="1ê³¼í•™ì‹¤">1ê³¼í•™ì‹¤</option>
                 <option value="2ê³¼í•™ì‹¤">2ê³¼í•™ì‹¤</option>
               </select>
            </div>
          </div>
          <div className="flex gap-2 pt-2">
            <button onClick={() => saveEditing(item.id)} className="flex-1 bg-green-600 text-white py-1 rounded text-sm flex items-center justify-center gap-1"><Save size={14}/> ì €ì¥</button>
            <button onClick={cancelEditing} className="flex-1 bg-gray-300 text-gray-700 py-1 rounded text-sm flex items-center justify-center gap-1"><X size={14}/> ì·¨ì†Œ</button>
          </div>
        </div>
      ) : (
        <>
          <div className="flex justify-between items-start mb-2">
            <div>
              <span className={`inline-block px-2 py-1 rounded text-xs font-bold mb-1 ${item.room === '1ê³¼í•™ì‹¤' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                {item.room}
              </span>
              <h3 className="text-lg font-bold text-gray-800">{item.item}</h3>
            </div>
            <div className="flex gap-1">
              <button onClick={() => startEditing(item)} className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors"><Edit2 size={16} /></button>
              {deleteConfirmId === item.id ? (
                <button onClick={() => deleteItem(item.id)} className="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded animate-pulse">ì‚­ì œ?</button>
              ) : (
                <button onClick={() => deleteItem(item.id)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"><Trash2 size={16} /></button>
              )}
            </div>
          </div>
          <div className="flex items-center gap-2 text-gray-600 mb-4 text-sm">
            <MapPin size={16} /><span>{item.location}</span>
          </div>
          <div className="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
            <span className="text-sm font-semibold text-gray-500 flex items-center gap-1"><Package size={16} /> ìˆ˜ëŸ‰</span>
            <div className="flex items-center gap-3">
              <button onClick={() => adjustQuantity(item.id, item.quantity, -1)} className="w-7 h-7 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:border-indigo-500 hover:text-indigo-600 transition-colors shadow-sm"><Minus size={14} /></button>
              <span className={`font-bold w-8 text-center ${item.quantity < 5 ? 'text-red-500' : 'text-gray-800'}`}>{item.quantity}</span>
              <button onClick={() => adjustQuantity(item.id, item.quantity, 1)} className="w-7 h-7 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:border-indigo-500 hover:text-indigo-600 transition-colors shadow-sm"><Plus size={14} /></button>
            </div>
          </div>
        </>
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 font-sans relative">
      {/* Toast Notification */}
      {toast && (
        <div className={`fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg flex items-center gap-2 z-50 animate-fade-in-up ${toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-slate-800 text-white'}`}>
          {toast.type === 'error' ? <AlertCircle size={20}/> : <Check size={20}/>}
          <span className="font-bold">{toast.message}</span>
        </div>
      )}

      <div className="max-w-5xl mx-auto">
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
          <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
               <h1 className="text-2xl md:text-3xl font-extrabold text-slate-800 flex items-center gap-3">
                <span className="bg-indigo-600 text-white p-2 rounded-lg"><TestTube size={24}/></span>
                ì—¬ìš¸ì´ˆ ê³¼í•™ì‹¤ ë¬¼í’ˆ ê²€ìƒ‰
               </h1>
               <div className="flex items-center gap-2 mt-2">
                 <p className="text-slate-500 ml-1">ë¬¼í’ˆëª…, ìœ„ì¹˜, ë˜ëŠ” ì‹¤í—˜ëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”</p>
                 {isOffline ? (
                   <div className="px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 bg-gray-200 text-gray-600">
                     <Database size={10}/> ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ì €ì¥ ì•ˆ ë¨)
                   </div>
                 ) : (
                   <div className={`px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 ${loading ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>
                     {loading ? <RefreshCw className="animate-spin" size={10}/> : <Database size={10}/>}
                     {loading ? 'DB ì—°ê²°ì¤‘...' : 'ì˜¨ë¼ì¸ ì—°ë™ë¨'}
                   </div>
                 )}
               </div>
            </div>
            <div className="flex flex-wrap gap-2 bg-slate-100 p-1.5 rounded-xl self-start">
               <button onClick={() => setActiveTab('search')} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Search size={16}/> ê²€ìƒ‰</button>
               <button onClick={() => setActiveTab('database')} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'database' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Database size={16}/> ì „ì²´ DB</button>
               <button onClick={() => setActiveTab('experiments')} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'experiments' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Beaker size={16}/> ì‹¤í—˜ëª©ë¡</button>
               <button onClick={() => setActiveTab('loans')} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'loans' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><ClipboardList size={16}/> ëŒ€ì—¬ ê´€ë¦¬</button>
            </div>
          </div>
        </div>

        {activeTab === 'search' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
              <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex items-center gap-2 text-sm font-medium text-slate-600 min-w-fit"><Filter size={18} /> í•„í„°:</div>
                <div className="flex gap-2">
                  <button onClick={() => setRoomFilter('all')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors border ${roomFilter === 'all' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>ì „ì²´</button>
                  <button onClick={() => setRoomFilter('1ê³¼í•™ì‹¤')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors border ${roomFilter === '1ê³¼í•™ì‹¤' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-green-50'}`}>1ê³¼í•™ì‹¤</button>
                  <button onClick={() => setRoomFilter('2ê³¼í•™ì‹¤')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors border ${roomFilter === '2ê³¼í•™ì‹¤' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-blue-50'}`}>2ê³¼í•™ì‹¤</button>
                </div>
              </div>
              <div className="relative mb-4">
                <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                <input type="text" placeholder="ì˜ˆ: ë¹„ì»¤, 1ê³¼êµ 1, ì „ê¸°íšŒë¡œ, ë Œì¦ˆ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-4 text-lg bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:bg-white focus:outline-none transition-all placeholder:text-slate-400" />
              </div>
              <button onClick={() => setShowAddForm(!showAddForm)} className="w-full py-3 border-2 border-dashed border-indigo-200 text-indigo-600 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-50 transition-colors">
                {showAddForm ? <X size={20}/> : <PlusCircle size={20}/>}{showAddForm ? 'ë‹«ê¸°' : 'ìƒˆ ë¬¼í’ˆ ì§ì ‘ ì¶”ê°€í•˜ê¸°'}
              </button>
            </div>
            {showAddForm && (
              <div className="bg-white rounded-2xl shadow-lg border border-indigo-100 p-6 animate-fade-in-down">
                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><span className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><Plus size={18}/></span>ìƒˆ ë¬¼í’ˆ ë“±ë¡</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div className="space-y-1"><label className="text-sm font-semibold text-slate-500">ë¬¼í’ˆëª…</label><input type="text" placeholder="ì˜ˆ: ë¹„ì»¤ 500ml" value={newItem.item} onChange={(e) => setNewItem({ ...newItem, item: e.target.value })} className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                  <div className="space-y-1"><label className="text-sm font-semibold text-slate-500">ìœ„ì¹˜</label><input type="text" placeholder="ì˜ˆ: 1ê³¼êµ 3" value={newItem.location} onChange={(e) => setNewItem({ ...newItem, location: e.target.value })} className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                  <div className="space-y-1"><label className="text-sm font-semibold text-slate-500">ë³´ê´€ ì¥ì†Œ</label><select value={newItem.room} onChange={(e) => setNewItem({ ...newItem, room: e.target.value })} className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white"><option value="1ê³¼í•™ì‹¤">1ê³¼í•™ì‹¤</option><option value="2ê³¼í•™ì‹¤">2ê³¼í•™ì‹¤</option></select></div>
                  <div className="space-y-1"><label className="text-sm font-semibold text-slate-500">ì´ˆê¸° ìˆ˜ëŸ‰</label><input type="number" placeholder="0" value={newItem.quantity} onChange={(e) => setNewItem({ ...newItem, quantity: parseInt(e.target.value) || 0 })} className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                </div>
                <div className="flex gap-3"><button onClick={addItem} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition-colors">ë“±ë¡í•˜ê¸°</button><button onClick={() => { setShowAddForm(false); setNewItem({ location: '', item: '', quantity: 0, room: '2ê³¼í•™ì‹¤' }); }} className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold transition-colors">ì·¨ì†Œ</button></div>
              </div>
            )}
            {searchTerm && searchResults.type !== 'none' ? (
              <div className="animate-fade-in">
                {searchResults.type === 'experiment' && (
                  <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-100 rounded-2xl p-6 shadow-sm">
                    <div className="flex flex-col md:flex-row md:items-start gap-4">
                      <div className="p-3 bg-white rounded-full shadow-sm text-purple-600"><Beaker size={32} /></div>
                      <div className="flex-1">
                        <div className="flex flex-wrap items-center gap-2 mb-2"><h3 className="text-xl font-bold text-purple-900">{searchResults.data.experiment.name}</h3><span className="px-2 py-1 bg-purple-200 text-purple-800 text-xs font-bold rounded-full">{searchResults.data.experiment.grade}í•™ë…„</span></div>
                        <div className="bg-white/60 rounded-lg p-3 backdrop-blur-sm"><p className="text-sm font-semibold text-purple-800 mb-1">ğŸ” í•„ìš” ì‹¤í—˜ ë„êµ¬:</p><div className="flex flex-wrap gap-2">{searchResults.data.experiment.tools.map((tool, idx) => (<span key={idx} className="px-2 py-1 bg-white border border-purple-100 rounded-md text-sm text-purple-700 shadow-sm">{tool}</span>))}</div></div>
                      </div>
                    </div>
                  </div>
                )}
                <div className="flex items-center justify-between mb-4 px-1"><h2 className="text-lg font-bold text-slate-700 flex items-center gap-2">{searchResults.type === 'experiment' ? <><Package size={20}/> ê´€ë ¨ ë¬¼í’ˆ ìœ„ì¹˜</> : <><Search size={20}/> ê²€ìƒ‰ ê²°ê³¼</>}<span className="ml-2 bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full text-sm">{searchResults.data.items?.length || searchResults.data.length}ê±´</span></h2></div>
                {((searchResults.data.items || searchResults.data).length > 0) ? (
                   <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{(searchResults.data.items || searchResults.data).map((item) => (<InventoryCard key={item.id} item={item} highlight={true} />))}</div>
                ) : (
                  <div className="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300"><div className="text-slate-300 mb-3 mx-auto flex justify-center"><Package size={48}/></div><p className="text-slate-500 font-medium">ê²€ìƒ‰ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div>
                )}
              </div>
            ) : (!searchTerm && (<div className="text-center py-20 opacity-50"><div className="inline-block p-6 bg-white rounded-full shadow-sm mb-4"><Search size={48} className="text-indigo-200" /></div><h3 className="text-xl font-bold text-slate-400 mb-2">ë¬¼í’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3><p className="text-slate-400">ì‹¤í—˜ ì´ë¦„ì´ë‚˜ ë„êµ¬ ì´ë¦„ì„ ì…ë ¥í•˜ë©´<br/>ìœ„ì¹˜ì™€ ì¬ê³ ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p></div>))}
          </div>
        )}

        {activeTab === 'database' && (
          <div className="space-y-6 animate-fade-in">
             <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                   <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Database size={24} className="text-indigo-600"/> ì „ì²´ ë¬¼í’ˆ ëª©ë¡</h2>
                   <div className="flex items-center gap-2">
                      <button onClick={uploadInitialData} disabled={uploading || isOffline} className={`px-3 py-1.5 rounded-lg text-sm font-bold border flex items-center gap-1 mr-2 ${isOffline ? 'bg-gray-100 text-gray-400 border-gray-200' : 'bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100'}`}>
                         {uploading ? <RefreshCw className="animate-spin" size={14}/> : <CloudUpload size={14}/>} ì´ˆê¸° ë°ì´í„° ì—…ë¡œë“œ
                      </button>
                      <div className="flex gap-2">
                        <button onClick={() => setRoomFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm font-bold border ${roomFilter === 'all' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600'}`}>ì „ì²´</button>
                        <button onClick={() => setRoomFilter('1ê³¼í•™ì‹¤')} className={`px-3 py-1.5 rounded-lg text-sm font-bold border ${roomFilter === '1ê³¼í•™ì‹¤' ? 'bg-green-600 text-white' : 'bg-white text-slate-600'}`}>1ê³¼í•™ì‹¤</button>
                        <button onClick={() => setRoomFilter('2ê³¼í•™ì‹¤')} className={`px-3 py-1.5 rounded-lg text-sm font-bold border ${roomFilter === '2ê³¼í•™ì‹¤' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600'}`}>2ê³¼í•™ì‹¤</button>
                      </div>
                   </div>
                </div>
                {loading ? (<div className="py-20 text-center text-slate-400"><RefreshCw className="animate-spin mx-auto mb-2" size={32}/>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{filteredInventory.map((item) => (<InventoryCard key={item.id} item={item} />))}{filteredInventory.length === 0 && (<div className="col-span-full text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. 'ì´ˆê¸° ë°ì´í„° ì—…ë¡œë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš” (ì˜¨ë¼ì¸ ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥).</div>)}</div>
                )}
             </div>
          </div>
        )}

        {activeTab === 'experiments' && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
               <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Beaker size={24} className="text-indigo-600"/> ë“±ë¡ëœ ì‹¤í—˜ ëª©ë¡</h2>
               <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                 {experiments.map((exp, idx) => (
                   <button key={idx} onClick={() => { setSearchTerm(exp.name); setActiveTab('search'); }} className="flex flex-col text-left bg-slate-50 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-xl p-5 transition-all group">
                     <div className="flex justify-between items-start w-full mb-2"><h3 className="text-lg font-bold text-slate-700 group-hover:text-indigo-700">{exp.name}</h3><span className="text-xs font-bold bg-white text-slate-500 border border-slate-200 px-2 py-1 rounded-full group-hover:border-indigo-200 group-hover:text-indigo-600">{exp.grade}í•™ë…„</span></div>
                     <p className="text-sm text-slate-500 group-hover:text-slate-600">{exp.tools.join(', ')}</p>
                   </button>
                 ))}
               </div>
            </div>
          </div>
        )}

        {activeTab === 'loans' && (
          <div className="space-y-6 animate-fade-in">
            {/* ëŒ€ì—¬ ì…ë ¥ í¼ */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
               <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                 <ClipboardList size={24} className="text-indigo-600"/> ëŒ€ì—¬ ê¸°ë¡í•˜ê¸°
               </h2>
               <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-4 rounded-xl">
                 <div className="md:col-span-3 space-y-1">
                   <label className="text-sm font-semibold text-slate-500 flex items-center gap-1"><User size={14}/> ëŒ€ì—¬ì ì´ë¦„</label>
                   <input 
                     type="text" 
                     placeholder="ì˜ˆ: í™ê¸¸ë™ (6-1)" 
                     value={newLoan.borrower} 
                     onChange={(e) => setNewLoan({...newLoan, borrower: e.target.value})} 
                     className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" 
                   />
                 </div>
                 <div className="md:col-span-5 space-y-1">
                   <label className="text-sm font-semibold text-slate-500 flex items-center gap-1"><Package size={14}/> ë¬¼í’ˆ ì„ íƒ</label>
                   <select 
                     value={newLoan.itemId} 
                     onChange={(e) => setNewLoan({...newLoan, itemId: e.target.value})}
                     className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
                   >
                     <option value="">ë¬¼í’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                     {inventory.map(item => (
                       <option key={item.id} value={item.id}>{item.item} ({item.room}, {item.location}) - ì”ì—¬ {item.quantity}ê°œ</option>
                     ))}
                   </select>
                 </div>
                 <div className="md:col-span-2 space-y-1">
                   <label className="text-sm font-semibold text-slate-500 flex items-center gap-1">ìˆ˜ëŸ‰</label>
                   <input 
                     type="number" 
                     min="1"
                     value={newLoan.quantity} 
                     onChange={(e) => setNewLoan({...newLoan, quantity: parseInt(e.target.value) || 1})} 
                     className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" 
                   />
                 </div>
                 <div className="md:col-span-2">
                   <button 
                     onClick={addLoan}
                     className="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-1"
                   >
                     <PlusCircle size={18}/> ëŒ€ì—¬
                   </button>
                 </div>
               </div>
            </div>

            {/* ëŒ€ì—¬ ì¤‘ì¸ ë¬¼í’ˆ ë¦¬ìŠ¤íŠ¸ */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
               <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                 <Clock size={20} className="text-orange-500"/> ëŒ€ì—¬ ì¤‘ì¸ ë¬¼í’ˆ <span className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs">{activeLoans.length}ê±´</span>
               </h3>
               {activeLoans.length > 0 ? (
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                   {activeLoans.map(loan => (
                     <div key={loan.id} className="border border-orange-200 bg-orange-50 rounded-xl p-4 flex flex-col justify-between">
                       <div className="flex justify-between items-start mb-2">
                         <div>
                           <h4 className="font-bold text-slate-800">{loan.itemName}</h4>
                           <span className="text-xs text-slate-500 bg-white px-2 py-0.5 rounded border border-orange-100">{loan.itemRoom || 'ê³¼í•™ì‹¤'}</span>
                         </div>
                         <div className="text-right">
                           <span className="block font-bold text-indigo-700">{loan.borrower}</span>
                           <span className="text-xs text-slate-500">{loan.quantity}ê°œ ëŒ€ì—¬</span>
                         </div>
                       </div>
                       <div className="text-sm text-slate-600 mb-3 flex items-center gap-1">
                         <Calendar size={14}/> {loan.borrowDate}
                       </div>
                       <button 
                         onClick={() => returnLoan(loan.id)}
                         className="w-full py-2 bg-white border border-orange-300 text-orange-600 hover:bg-orange-100 font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-sm"
                       >
                         <CheckCircle size={16}/> ë°˜ë‚© ì²˜ë¦¬ (ì¬ê³  ìë™ ë³µêµ¬)
                       </button>
                     </div>
                   ))}
                 </div>
               ) : (
                 <div className="text-center py-8 text-slate-400">ëŒ€ì—¬ ì¤‘ì¸ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
               )}
            </div>

            {/* ë°˜ë‚© ì™„ë£Œ ë‚´ì—­ */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 opacity-80">
               <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                 <History size={20} className="text-slate-400"/> ìµœê·¼ ë°˜ë‚© ê¸°ë¡
               </h3>
               {returnedLoans.length > 0 ? (
                 <div className="overflow-x-auto">
                   <table className="w-full text-sm text-left text-slate-600">
                     <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                       <tr>
                         <th className="px-4 py-3 rounded-l-lg">ë¬¼í’ˆëª…</th>
                         <th className="px-4 py-3">ëŒ€ì—¬ì</th>
                         <th className="px-4 py-3">ëŒ€ì—¬ì¼ì‹œ</th>
                         <th className="px-4 py-3 rounded-r-lg">ë°˜ë‚©ì¼ì‹œ</th>
                       </tr>
                     </thead>
                     <tbody>
                       {returnedLoans.slice(0, 10).map(loan => (
                         <tr key={loan.id} className="border-b border-slate-100 hover:bg-slate-50">
                           <td className="px-4 py-3 font-medium text-slate-800">{loan.itemName} <span className="text-xs text-slate-400">({loan.quantity}ê°œ)</span></td>
                           <td className="px-4 py-3">{loan.borrower}</td>
                           <td className="px-4 py-3 text-xs">{loan.borrowDate}</td>
                           <td className="px-4 py-3 text-xs text-green-600 font-medium">{loan.returnDate}</td>
                         </tr>
                       ))}
                     </tbody>
                   </table>
                 </div>
               ) : (
                 <div className="text-center py-4 text-slate-400">ë°˜ë‚© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
               )}
            </div>
          </div>
        )}

        <div className="mt-8 text-center text-slate-400 text-sm pb-8"><p>Â© 2024 ì—¬ìš¸ì´ˆë“±í•™êµ ê³¼í•™ì‹¤ ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ</p></div>
      </div>
    </div>
  );
};
export default App;